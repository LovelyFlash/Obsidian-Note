---
tags:
  - 课程/CPP程序设计
title: 变量的存储位置特性
date created: 星期一, 十月 20日 2025, 10:40:55 上午
date modified: 星期三, 十月 22日 2025, 4:46:29 下午
---

# 1 内存区域详解

## 1.1 数据段

- **存储内容：** 存储**已初始化**的全局变量和静态变量。
- **存储期：** 具有静态存储期。
- **生命周期：** 它们在程序启动时被创建，并在程序结束时被销毁。其生命周期贯穿整个程序的执行过程。
- **示例：**
```C++
int globalInitializedVar = 10;     // 存储在数据段
static int staticInitializedVar = 20; // 存储在数据段 (文件作用域或函数内部的静态变量)
```
  

## 1.2 BSS 段 (Block Started by Symbol Segment)

- **存储内容：** 存储**未初始化**的全局变量和静态变量（包括被显式初始化为 0 的变量）。
- **存储期：** 同样具有**静态存储期**。
- **生命周期：** 它们在程序启动时被创建，并在程序结束时被销毁。
- **特点：** 在可执行文件中不占用实际存储空间，只记录变量名和大小。程序加载时，操作系统或加载器会负责为其分配内存，并将其**全部初始化为零**。
- **示例：**
```C++  
int globalUninitializedVar;        // 存储在 BSS 段 (默认初始化为 0)
static int staticUninitializedVar; // 存储在 BSS 段 (默认初始化为 0)
  ```

## 1.3 栈

- **存储内容：** 存储函数内部定义的**局部变量**（也称为自动变量），以及函数调用的上下文信息（如返回地址、函数参数）。
- **存储期：** 具有**自动存储期 (Automatic Storage Duration)**。
- **生命周期：** 它们在函数被调用时创建，在函数返回时销毁。
- **特点：** 内存由编译器自动管理，分配和释放速度快。
- **示例：**
```C++
void myFunction() {
    int localVariable = 5; // 存储在栈上
    // …
}
 ``` 

## 1.4 堆

- **存储内容：** 存储通过 new 或 malloc 等动态内存分配函数在运行时分配的内存。
- **存储期：** 具有**动态存储期 (Dynamic Storage Duration)**。
- **生命周期：** 它们的生命周期由程序员手动控制（通过 `delete` 或 `free`），直到程序结束。
- **特点：** 内存分配和释放相对较慢，容易产生内存碎片，需要程序员谨慎管理以避免内存泄漏。
- **示例：**
```C++
int* dynamicVar = new int(10); // 存储在堆上
// …
delete dynamicVar; // 必须手动释放
  ```

# 2 变量的存储期、作用域与链接性对存储位置的影响

变量的存储位置主要由其**存储期 (Storage Duration)** 决定，而存储期又受到变量的**声明位置**、**关键字**（如 static, extern）以及**链接性 (Linkage)** 的影响。

## 2.1 自动存储期变量

- **声明位置：** 函数内部（包括代码块内）。
- **关键字：** 默认（auto 关键字是缺省值，通常省略）。
- **作用域：** 块作用域 (Block Scope)。
- **链接性：** 无链接 (No Linkage)。
- **存储位置：** **栈**。
- **示例：**
```C++
int x = 5; (在函数内部)
```

- 并不是执行到定义语句时，才分配空间，而是一进入函数，就分配了空间。
- 编译的时候，编译器就做了“计划”，将局部变量放在何处（在栈中的一个相对位置）；
- 执行到函数时，相当于函数“取得栈的使用权”，函数内的局部变量“计划的空间”都“变成了现实”。
- 函数结束时，函数被“剥夺栈的使用权”，此时释放变量所占用的空间。

# 2.2 静态存储期变量

- **特点：** 变量在程序启动时创建，程序结束时销毁。
- **存储位置：** **数据段** (如果已初始化) 或 **BSS 段** (如果未初始化或初始化为 0)。

## 2.2.1 全局变量

◦ **声明位置：** 函数外部。
◦ **关键字：** 默认（具有外部链接）。
◦ **作用域：** 文件作用域 (File Scope)。
◦ **链接性：** 外部链接 (External Linkage)。
◦ **示例：** 
```C++
int globalVar = 10; (数据段)；
int globalUninitVar; (BSS 段)
```

## 2.2.2 文件作用域静态变量

◦ **声明位置：** 函数外部。
◦ **关键字：** static。
◦ **作用域：** 文件作用域 (File Scope)。
◦ **链接性：** 内部链接 (Internal Linkage)。
◦ **示例：** 
```C++
static int fileStaticVar = 20; // 数据段
static int fileStaticUninitVar; // BSS段
```

## 2.2.3 局部静态变量

◦ **声明位置：** 函数内部。
◦ **关键字：** static。
◦ **作用域：** 块作用域 (Block Scope)。
◦ **链接性：** 无链接 (No Linkage)。
◦ **特点：** 只在程序第一次执行到其声明时初始化一次。
◦ **示例：** 
```C++
void func() { static int localStaticVar = 30; } // 数据段
void func() { static int localStaticUninitVar; } // BSS段
```

# 2.3 动态存储期变量

- **声明位置：** 通过 `new` 或 `malloc` 等动态内存分配函数在运行时分配。
- **关键字：** 无特定关键字，通过函数调用。
- **作用域：** 无特定作用域，通过指针访问。
- **链接性：** 无链接。
- **存储位置：** **堆**。
- **示例：** 
```C++
int* ptr = new int;
```

# 2.4 `extern` 关键字

- extern 关键字用于**声明**一个变量或函数，表明其**定义**在别处（通常是另一个编译单元）。
- 它不影响变量的存储位置，也不分配存储空间。它只是告诉编译器该变量具有**外部链接**，以便在链接阶段找到其定义。
- **示例：**
```C++
extern int someGlobalVar; // 这只是声明，someGlobalVar 的实际存储位置取决于其定义
```

# 3 总结

1. **存储期决定生命周期：** 变量的存储期（自动、静态、动态）决定了其在程序运行期间的生命周期。
2. **栈空间具有临时性：** 栈上的变量在函数调用时分配，函数返回时释放，具有快速分配和回收的特点。
3. **数据段/BSS 段空间持久性：** 存储在数据段和 BSS 段的变量具有静态存储期，贯穿整个程序的生命周期，其值在函数调用结束后依然保留。
4. **堆空间手动管理：** 堆上的内存由程序员手动分配和释放，提供了最大的灵活性，但也带来了内存泄漏和碎片化的风险。
5. **地址范围：** 不同存储区域的内存地址范围通常是不同的，这反映了它们在程序内存布局中的逻辑划分。
